

 SELECT  z.SUBSSN,
  isnull(mm.BRANCHCODE,'') HomingBranch,
 isnull(mm.ACCNR, '') HomingAccountNumber ,
mm.FIRSTNM + ' ' + mm.LASTNM HomingAccountName ,
1 AccountType ,
z.AMOUNTREQUESTED Amount ,
'AUL       ' +substring(z.SUBSSN,4,10)+'_'+CONVERT(varchar(10), @DATEREQUESTED,112) UserReference 
, CASE
        WHEN EffectiveBillingMonth IS NULL
          OR z.DeductionDay        IS NULL       -- either column missing ⇒ no date
        THEN NULL

        -- if the requested day exists in the month, use it
        WHEN z.DeductionDay <= DAY(EOMONTH(EffectiveBillingMonth))
        THEN DATEFROMPARTS(
                 YEAR(EffectiveBillingMonth),
                 MONTH(EffectiveBillingMonth),
                 z.DeductionDay)

        -- otherwise fall back to the month-end
        ELSE EOMONTH(EffectiveBillingMonth) end DATEREQUESTED

from [BILLING_SPECINSTRUCT] z
  inner JOIN MEMB_MASTERS MM ON MM.SUBSSN =  z.SUBSSN AND RLSHIP = 1 
  AND  CASE
        WHEN EffectiveBillingMonth IS NULL
          OR z.DeductionDay        IS NULL       -- either column missing ⇒ no date
        THEN NULL

        -- if the requested day exists in the month, use it
        WHEN z.DeductionDay <= DAY(EOMONTH(EffectiveBillingMonth))
        THEN DATEFROMPARTS(
                 YEAR(EffectiveBillingMonth),
                 MONTH(EffectiveBillingMonth),
                 z.DeductionDay)

        -- otherwise fall back to the month-end
        ELSE EOMONTH(EffectiveBillingMonth) end = @DATEREQUESTED where mm.subssn in ('MGS778090',
'MGS772652',
'MGS776010',
'MGS701195',
'MGS820599',
'MGS580000',
'MGS782175',
'MGS828969',
'MGS710888',
'MGS742429',
'MGS781213',
'MGS765433',
'MGS660679',
'MGS830312',
'MGS843110',
'MGS846311',
'MGS834882',
'MGS707086',
'MGS694395',
'MGS748105',
'MGS760755',
'MGS627700',
'MGS110210',
'MGS836038',
'MGS836034',
'MGS147708',
'MGS744825',
'MGS544406',
'MGS540159',
'MGS760969',
'MGS680544',
'MGS777610',
'MGS744352',
'MGS712260',
'MGS749194',
'MGS686874',
'MGS678850',
'MGS669519',
'MGS695764',
'MGS768011',
'MGS800740',
'MGS782319',
'MGS815365',
'MGS781700',
'MGS600337',
'MGS830866',
'MGS830207',
'MGS740820',
'MGS822817',
'MGS523921',
'MGS183077',
'MGS144600',
'MGS125485',
'MGS147919',
'MGS603084',
'MGS801869',
'MGS597557',
'MGS788053',
'MGS822169',
'MGS802249',
'MGS806168',
'MGS777072',
'MGS636106',
'MGS777179',
'MGS624645',
'MGS665350',
'MGS751508',
'MGS690331',
'MGS728390',
'MGS846812',
'MGS699681',
'MGS121214',
'MGS664265',
'MGS613098',
'MGS638088',
'MGS610494',
'MGS761681',
'MGS691909',
'MGS703235',
'MGS701673',
'MGS698109',
'MGS810038',
'MGS542198',
'MGS555063',
'MGS115923',
'MGS599473',
'MGS834653',
'MGS153718',
'MGS831323',
'MGS194819',
'MGS698967',
'MGS742738',
'MGS684300',
'MGS699250',
'MGS760816',
'MGS678460',
'MGS651277',
'MGS805850',
'MGS841508',
'MGS800441',
'MGS800006',
'MGS115958',
'MGS133122',
'MGS793006',
'MGS791031',
'MGS138117',
'MGS703857',
'MGS709411',
'MGS748558',
'MGS611734',
'MGS726006',
'MGS683813',
'MGS725399',
'MGS671209',
'MGS722221',
'MGS718660',
'MGS715221',
'MGS713457',
'MGS654680',
'MGS130591',
'MGS831167'
)
